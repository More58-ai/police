<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Національна поліція України</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --gold: #ffd700; 
            --blue: #0066ff; 
            --bg: #050505; 
            --white: #ffffff; 
            --online: #00ff88;
            --diamond: #b9f2ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body, html { width: 100%; height: 100%; font-family: 'Montserrat', sans-serif; background-color: var(--bg); color: white; overflow-x: hidden; }

        /* ЕФЕКТИ */
        #snow-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1002; }
        .background-scene { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: url('https://i.postimg.cc/V6dqQJmL/Gemini-Generated-Image-1jznmn1jznmn1jzn.png'); background-size: cover; background-position: center; z-index: -2; filter: brightness(0.12) blur(5px); }
        .gradient-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 0%, rgba(5,5,5,0.9) 100%); z-index: -1; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; position: fixed; width: 100%; top: 0; z-index: 1000; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,215,0,0.3); }
        .logo-container { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 50px; }

        /* HERO SECTION */
        .hero { min-height: 100vh; padding: 120px 5% 50px; display: flex; align-items: center; position: relative; }
        .hero-content { z-index: 10; max-width: 800px; }
        .hero-img { position: absolute; right: 2%; bottom: 0; height: 85vh; z-index: 1; pointer-events: none; }
        .hero h1 { font-size: clamp(30px, 6vw, 70px); font-weight: 900; line-height: 1; text-transform: uppercase; margin-bottom: 20px; }
        
        .unit-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 30px; max-width: 400px; }

        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 450px; height: 100%; background: rgba(5,5,5,0.98); z-index: 3000; transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); padding: 80px 40px; border-left: 2px solid var(--gold); overflow-y: auto; }
        .sidebar.active { right: 0; }
        .side-logo { width: 180px; display: block; margin: 0 auto 30px; }
        .side-text { font-size: 14px; line-height: 1.8; opacity: 0.8; margin-bottom: 40px; text-align: justify; }

        /* РОЛІ ТА АНІМАЦІЇ */
        .role-badge { font-size: 10px; padding: 5px 12px; border-radius: 6px; font-weight: 900; text-transform: uppercase; display: inline-block; margin: 2px; position: relative; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        @keyframes rb { 0%{background-position:0%} 100%{background-position:200%} }
        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

        .role-admin { background: linear-gradient(90deg, #f00, #ff0, #f00); background-size: 200%; animation: rb 3s linear infinite; color: #fff; }
        .role-leader { background: linear-gradient(90deg, #bf953f, #fcf6ba, #b38728, #fcf6ba, #bf953f); background-size: 200%; animation: rb 3s linear infinite; color: #000; }
        .role-colonel { background: linear-gradient(90deg, #b9f2ff, #ffffff, #81d4fa, #ffffff, #b9f2ff); background-size: 200%; animation: rb 3s linear infinite; color: #01579b; }
        .role-worker { background: linear-gradient(90deg, #00c6ff, #0072ff, #00c6ff); background-size: 200%; animation: rb 3s linear infinite; color: #fff; }
        .role-chief { color: white; border: 1px solid rgba(255,255,255,0.4); }
        .role-chief::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.6), transparent); transform: rotate(45deg); animation: shine 2s infinite; }
        .role-officer { background: #0044ff; color: white; }
        .role-citizen { background: #333; color: #ccc; }

        /* ПАНЕЛІ ТА КАРТКИ */
        .staff-page { position: fixed; inset: 0; background: #050505; z-index: 4000; display: none; padding: 100px 5% 50px; overflow-y: auto; }
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .staff-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,215,0,0.1); border-radius: 15px; padding: 15px; display: flex; align-items: center; gap: 15px; transition: 0.3s; position: relative; }
        .staff-ava { width: 70px; height: 70px; border-radius: 15px; object-fit: cover; }
        .btn-gold { border: 2px solid var(--gold); color: var(--gold); padding: 10px 20px; background: transparent; cursor: pointer; font-weight: 900; text-transform: uppercase; border-radius: 4px; transition: 0.3s; font-size: 11px; }
        .btn-gold:hover { background: var(--gold); color: black; box-shadow: 0 0 20px var(--gold); }
        .admin-controls { background: rgba(15,15,15,0.98); border: 1px solid var(--gold); padding: 25px; border-radius: 20px; margin-top: 40px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body onclick="playMusic()">

    <audio id="bg-music" loop><source src="https://raw.githubusercontent.com/More58-ai/NPU/main/Wham!%20-%20Last%20Christmas%20(Official%20Video).mp3" type="audio/mpeg"></audio>
    <canvas id="snow-canvas"></canvas>
    <div class="background-scene"></div>
    <div class="gradient-mask"></div>

    <header>
        <div class="logo-container">
            <img src="https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png" class="header-logo">
            <b style="letter-spacing:1px; font-size: 14px;">НАЦІОНАЛЬНА ПОЛІЦІЯ УКРАЇНИ</b>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-gold" onclick="openPage('page-staff')">РЕЄСТР</button>
            <button class="btn-gold" onclick="toggleModal('modal-account', true)">ПРОФІЛЬ</button>
        </div>
    </header>

    <main class="hero">
        <img src="https://i.postimg.cc/QtKW3skc/snapedit-1768682778382-removebg-preview.png" class="hero-img">
        <div class="hero-content">
            <h1>СЛУЖИТИ ТА<br><span style="color:var(--gold)">ЗАХИЩАТИ</span></h1>
            <p style="opacity:0.7; max-width: 500px; line-height:1.6; margin-bottom: 20px;">Офіційний портал Головного Управління Національної Поліції. Ми забезпечуємо правопорядок та безпеку кожного громадянина України.</p>
            <div class="unit-nav">
                <button class="btn-gold" onclick="openSidebar('pp')">Патрульна</button>
                <button class="btn-gold" onclick="openSidebar('kord')">КОРД</button>
                <button class="btn-gold" onclick="openSidebar('gsu')">ГСУ</button>
                <button class="btn-gold" onclick="openPage('page-gallery')">Галерея</button>
            </div>
        </div>
    </main>

    <div id="side-panel" class="sidebar">
        <button onclick="closeSidebar()" style="position:absolute; top:30px; left:30px; background:none; border:none; color:var(--gold); font-size:30px; cursor:pointer;">&times;</button>
        <img id="side-img" src="" class="side-logo">
        <h2 id="side-title" style="text-align:center; color:var(--gold); margin-bottom:20px; font-weight:900;"></h2>
        <p id="side-desc" class="side-text"></p>
        <div style="text-align:center; margin-top:20px;">
             <button class="btn-gold" style="width:100%;">КЕРІВНИК ПІДРОЗДІЛУ</button>
             <div id="unit-chief-display" style="margin-top:15px; padding:15px; border:1px solid rgba(255,215,0,0.2); border-radius:10px;"></div>
        </div>
    </div>

    <div id="page-staff" class="staff-page">
        <div style="max-width:1200px; margin:0 auto;">
            <h1 style="text-align:center; color:var(--gold); margin-bottom:40px; font-weight:900;">ОСОБОВИЙ СКЛАД</h1>
            <div id="staff-list" class="staff-grid"></div>
            <div id="admin-panel" class="admin-controls" style="display:none;">
                <h3 style="color:var(--gold); margin-bottom:20px;">ПАНЕЛЬ КЕРУВАННЯ (ДОСТУПНІ ПРАВА)</h3>
                <div id="admin-user-list"></div>
            </div>
            <button class="btn-gold" style="margin:40px auto; display:block;" onclick="closePage('page-staff')">НАЗАД</button>
        </div>
    </div>

    <div id="page-gallery" class="staff-page">
        <div style="max-width:1200px; margin:0 auto;">
            <h1 style="text-align:center; color:var(--gold); margin-bottom:40px;">ГАЛЕРЕЯ СЛУЖБИ</h1>
            <div style="text-align:center; margin-bottom:30px;">
                <label class="btn-gold"> ЗАВАНТАЖИТИ ФОТО <input type="file" id="gal-input" style="display:none" onchange="uploadToGallery(this)"></label>
            </div>
            <div id="gallery-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
            <button class="btn-gold" style="margin:40px auto; display:block;" onclick="closePage('page-gallery')">НАЗАД</button>
        </div>
    </div>

    <div id="modal-account" class="modal">
        <div style="width:100%; max-width:400px; text-align:center; background:#0a0a0a; border:1px solid var(--gold); border-radius:20px; padding:30px;">
            <img id="my-ava" src="" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-bottom:15px;">
            <h2 id="my-nick" style="margin-bottom:10px;">...</h2>
            <div id="my-roles-box" style="margin-bottom:20px;"></div>
            <input type="text" id="new-ava-url" placeholder="URL нової аватарки" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; margin-bottom:10px; border-radius:5px;">
            <button class="btn-gold" onclick="updateAvatar()" style="width:100%; margin-bottom:10px;">Оновити фото</button>
            <button class="btn-gold" style="width:100%; border-color:red; color:red;" onclick="logout()">ВИЙТИ З АКАУНТУ</button>
            <p onclick="toggleModal('modal-account', false)" style="margin-top:15px; cursor:pointer; opacity:0.5;">Закрити</p>
        </div>
    </div>

    <div id="auth-screen" style="position:fixed; inset:0; background:#050505; z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div style="background:#0a0a0a; padding:40px; border-radius:20px; border:1px solid var(--gold); text-align:center; width:350px;">
            <img src="https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png" style="height:60px; margin-bottom:20px;">
            <input id="ln" placeholder="Позивний" style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #333; color:white;">
            <input id="lp" type="password" placeholder="Пароль" style="width:100%; padding:12px; margin-bottom:20px; background:#111; border:1px solid #333; color:white;">
            <button class="btn-gold" style="width:100%" onclick="login()">УВІЙТИ</button>
            <p style="margin-top:15px; font-size:10px; opacity:0.4; cursor:pointer;" onclick="reg()">Зареєструвати позивний</p>
        </div>
    </div>

    <script type="module">
        /* --- НОВИЙ КОД ЗАХИСТУ --- */
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                return false;
            }
        });
        /* --- КІНЕЦЬ ЗАХИСТУ --- */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const config = { databaseURL: "https://npuofukraine-default-rtdb.firebaseio.com/" };
        const app = initializeApp(config);
        const db = getDatabase(app);
        const curID = localStorage.getItem('npu_user');

        // ІЄРАРХІЯ РОЛЕЙ
        const ROLE_MAP = {
            admin: { l: "Адміністратор", c: "role-admin", s: "0 0 15px #ff0000", p: 100 },
            leader: { l: "Лідер", c: "role-leader", s: "0 0 15px #ffd700", p: 90 },
            colonel: { l: "Полковник", c: "role-colonel", s: "0 0 15px #b9f2ff", p: 80 },
            chief_pp: { l: "Керівник ПП", c: "role-chief", bg: "linear-gradient(90deg, #0052D4, #4364F7, #6FB1FC)", s: "0 0 10px #4364F7", p: 75 },
            chief_kord: { l: "Керівник КОРД", c: "role-chief", bg: "linear-gradient(90deg, #1e1e1e, #b71c1c, #1e1e1e)", s: "0 0 10px #b71c1c", p: 75 },
            chief_gsu: { l: "Керівник ГСУ", c: "role-chief", bg: "linear-gradient(90deg, #004d40, #00c853, #004d40)", s: "0 0 10px #00c853", p: 75 },
            worker: { l: "Працівник", c: "role-worker", bg: "linear-gradient(90deg, #00c6ff, #0072ff, #00c6ff)", s: "0 0 15px #0072ff", p: 60 },
            officer: { l: "Офіцер", c: "role-officer", s: "none", p: 40 },
            citizen: { l: "Громадянин", c: "role-citizen", s: "none", p: 10 }
        };

        const UNIT_DATA = {
            pp: { title: "Патрульна Поліція", img: "https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png", desc: "Департамент патрульної поліції — міжрегіональний територіальний орган Нацполіції, який забезпечує публічну безпеку та порядок, охорону прав і свобод людини.", role: "chief_pp" },
            kord: { title: "Корпус Оперативно-Раптової Дії", img: "https://i.postimg.cc/vZmnJ1QV/kord-removebg-preview.png", desc: "Спецпідрозділ поліції для вирішення надзвичайних ситуацій, рівень підготовки якого відповідає світовим стандартам тактичних операцій.", role: "chief_kord" },
            gsu: { title: "Головне Слідче Управління", img: "https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png", desc: "Центральний орган, що організовує досудове розслідування кримінальних правопорушень та забезпечує взаємодію підрозділів слідства.", role: "chief_gsu" }
        };

        function getRoles(u) { return Array.isArray(u.roles) ? u.roles : Object.values(u.roles || ['citizen']); }
        function getTopRole(roles) {
            let top = 'citizen'; let maxP = 0;
            roles.forEach(r => { if(ROLE_MAP[r] && ROLE_MAP[r].p > maxP) { maxP = ROLE_MAP[r].p; top = r; } });
            return top;
        }

        // ПЕРЕВІРКА АВТОРИЗАЦІЇ
        if(curID) {
            onValue(ref(db, 'staff/'+curID), s => {
                const u = s.val(); if(!u) return;
                document.getElementById('auth-screen').style.display='none';
                document.getElementById('my-nick').innerText = u.nickname;
                document.getElementById('my-ava').src = u.avatar || "https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png";
                let rh = ''; getRoles(u).forEach(r => {
                    const m = ROLE_MAP[r]; if(!m) return;
                    rh += `<span class="role-badge ${m.c}" ${m.bg?`style="background:${m.bg};background-size:200%;animation:rb 3s linear infinite;"`:''}>${m.l}</span>`;
                });
                document.getElementById('my-roles-box').innerHTML = rh;
                if(getRoles(u).some(r => r === 'admin' || r === 'leader')) document.getElementById('admin-panel').style.display = 'block';
            });
        }

        // РЕЄСТР ТА АДМІНКА
        onValue(ref(db, 'staff'), s => {
            const users = s.val() || {};
            const list = document.getElementById('staff-list');
            const adm = document.getElementById('admin-user-list');
            list.innerHTML = ""; adm.innerHTML = "";
            const myMaxP = curID && users[curID] ? ROLE_MAP[getTopRole(getRoles(users[curID]))].p : 0;

            Object.entries(users).forEach(([id, u]) => {
                const roles = getRoles(u);
                const topKey = getTopRole(roles);
                list.innerHTML += `<div class="staff-card">
                    <img src="${u.avatar || 'https://i.postimg.cc/KcBqpWz7/npu-removebg-preview.png'}" class="staff-ava">
                    <div><b style="text-shadow:${ROLE_MAP[topKey].s}">${u.nickname}</b><br>
                        ${roles.map(r => {
                            const m = ROLE_MAP[r];
                            return `<span class="role-badge ${m.c}" ${m.bg?`style="background:${m.bg};background-size:200%;animation:rb 3s linear infinite;"`:''}>${m.l}</span>`;
                        }).join('')}
                    </div>
                </div>`;

                if(myMaxP >= 90) { 
                    adm.innerHTML += `<div style="padding:15px; border-bottom:1px solid #222;">
                        <b>${u.nickname}</b>
                        <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                            ${Object.keys(ROLE_MAP).map(rk => {
                                if(ROLE_MAP[rk].p < myMaxP) {
                                    const has = roles.includes(rk);
                                    return `<button class="btn-gold" style="padding:4px; font-size:8px; ${has?'border-color:red;color:red':''}" 
                                        onclick="window.toggleRole('${id}', '${rk}', ${!has})">${has?'Зняти':'Дати'} ${ROLE_MAP[rk].l}</button>`;
                                } return '';
                            }).join('')}
                        </div>
                    </div>`;
                }
            });
        });

        // ГАЛЕРЕЯ
        onValue(ref(db, 'gallery'), s => {
            const gl = document.getElementById('gallery-list'); gl.innerHTML = "";
            Object.entries(s.val()||{}).forEach(([key, img]) => {
                gl.innerHTML += `<div style="background:#0a0a0a; border-radius:10px; overflow:hidden; border:1px solid #222;">
                    <img src="${img.url}" style="width:100%; height:200px; object-fit:cover;">
                    <div style="padding:10px; font-size:10px; color:var(--gold);">Автор: ${img.author}</div>
                </div>`;
            });
        });

        window.toggleRole = async (uid, role, add) => {
            const s = await get(ref(db, 'staff/'+uid));
            let r = getRoles(s.val());
            if(add) { if(!r.includes(role)) r.push(role); if(role.startsWith('chief_')) await update(ref(db, 'staff/'+uid), { chief_of: role.split('_')[1] }); } 
            else { r = r.filter(x => x !== role); if(role.startsWith('chief_')) await update(ref(db, 'staff/'+uid), { chief_of: null }); }
            if(r.length === 0) r = ['citizen'];
            await update(ref(db, 'staff/'+uid), { roles: r });
        };

        window.updateAvatar = async () => {
            const url = document.getElementById('new-ava-url').value;
            if(url) { await update(ref(db, 'staff/'+curID), { avatar: url }); alert('Оновлено!'); }
        };

        window.openSidebar = async (t) => {
            const d = UNIT_DATA[t];
            document.getElementById('side-img').src = d.img;
            document.getElementById('side-title').innerText = d.title;
            document.getElementById('side-desc').innerText = d.desc;
            document.getElementById('side-panel').classList.add('active');
            const s = await get(ref(db, 'staff'));
            let chief = null;
            Object.values(s.val()||{}).forEach(u => { if(getRoles(u).includes(d.role)) chief = u; });
            document.getElementById('unit-chief-display').innerHTML = chief ? `<b style="color:var(--gold); font-size:18px;">${chief.nickname}</b><br><span class="role-badge role-chief">ДІЮЧИЙ КЕРІВНИК</span>` : 'Вакантна посада';
        };

        window.login = async () => {
            const n = document.getElementById('ln').value.trim();
            const p = document.getElementById('lp').value.trim();
            const s = await get(ref(db, 'staff/'+n));
            if(s.exists() && s.val().password === p) { localStorage.setItem('npu_user', n); location.reload(); }
            else alert("Невірний нікнейм або пароль!");
        };

        window.reg = async () => {
            const n = document.getElementById('ln').value.trim();
            const p = document.getElementById('lp').value.trim();
            if (!n || !p) { alert("Введіть позивний та пароль"); return; }
            try {
                const s = await get(ref(db, 'staff/' + n));
                if (s.exists()) { alert("Цей позивний вже зайнятий!"); return; }
                await set(ref(db, 'staff/' + n), { nickname: n, password: p, roles: ['citizen'], avatar: "" });
                localStorage.setItem('npu_user', n);
                location.reload();
            } catch (e) { alert("Помилка реєстрації."); }
        };

        window.uploadToGallery = async (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                await push(ref(db, 'gallery'), { url: e.target.result, author: curID });
                alert("Додано в галерею!");
            };
            reader.readAsDataURL(file);
        };

        window.closeSidebar = () => document.getElementById('side-panel').classList.remove('active');
        window.openPage = (id) => document.getElementById(id).style.display = 'block';
        window.closePage = (id) => document.getElementById(id).style.display = 'none';
        window.toggleModal = (id, s) => document.getElementById(id).style.display = s ? 'flex' : 'none';
        window.logout = () => { localStorage.clear(); location.reload(); };

        // СНІГ
        const cvs=document.getElementById('snow-canvas'); const ctx=cvs.getContext('2d'); let fs=[];
        function res(){ cvs.width=window.innerWidth; cvs.height=window.innerHeight; fs=[]; for(let i=0;i<80;i++) fs.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, r:Math.random()*2+1, s:Math.random()*1+0.5}); }
        function drw(){ ctx.clearRect(0,0,cvs.width,cvs.height); ctx.fillStyle="white"; ctx.beginPath(); fs.forEach(f=>{ ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.s; if(f.y>cvs.height)f.y=-5; }); ctx.fill(); requestAnimationFrame(drw); }
        res(); drw(); window.onresize=res;
        
        let aOn=false; window.playMusic=()=>{ if(!aOn){ document.getElementById('bg-music').play(); aOn=true; } };
    </script>
</body>
</html>
